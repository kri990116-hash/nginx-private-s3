name: Deploy Nginx Container (S3 -> Private EC2 via SSM)

on:
  push:
    branches: ["main"]

permissions:
  contents: read

env:
  S3_BUCKET: hs-cicd-bucket
  S3_PREFIX: nginx

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: "${{ secrets.AWS_ACCESS_KEY_ID }}"
          aws-secret-access-key: "${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          aws-region: "${{ secrets.AWS_REGION }}"

      # 1) S3 업로드 (default.conf + html)
      - name: Upload default.conf to S3
        run: |
          aws s3 cp nginx/default.conf s3://${S3_BUCKET}/${S3_PREFIX}/default.conf

      - name: Upload html to S3 (sync)
        run: |
          aws s3 sync nginx/html s3://${S3_BUCKET}/${S3_PREFIX}/html --delete

      # 2) SSM으로 EC2에서 S3 파일 다운로드 + nginx 컨테이너 재생성
      - name: Apply on EC2 via SSM
        run: |
          aws ssm send-command \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy nginx conf/html from s3://${S3_BUCKET}/${S3_PREFIX}/ (docker nginx:alpine)" \
            --parameters 'commands=[
              "set -e",

              "# 필수 패키지 설치 (Ubuntu)",
              "sudo apt-get update -y",
              "sudo apt-get install -y awscli docker.io ca-certificates curl",

              "# Docker 활성화",
              "sudo systemctl enable docker",
              "sudo systemctl start docker",

              "# S3에서 파일 내려받기",
              "sudo mkdir -p /opt/nginx/conf /opt/nginx/html",
              "aws s3 cp s3://'${S3_BUCKET}'/'${S3_PREFIX}'/default.conf /tmp/default.conf",
              "aws s3 sync s3://'${S3_BUCKET}'/'${S3_PREFIX}'/html /tmp/html --delete",

              "# 로컬 경로에 반영",
              "sudo cp /tmp/default.conf /opt/nginx/conf/default.conf",
              "sudo rm -rf /opt/nginx/html/*",
              "sudo cp -r /tmp/html/* /opt/nginx/html/",

              "# nginx 컨테이너 재생성 (이미지 재빌드 없음)",
              "sudo docker pull nginx:alpine",
              "sudo docker rm -f nginx-server || true",
              "sudo docker run -d --name nginx-server --restart unless-stopped -p 80:80 \
                -v /opt/nginx/conf/default.conf:/etc/nginx/conf.d/default.conf:ro \
                -v /opt/nginx/html:/usr/share/nginx/html:ro \
                nginx:alpine",

              "# (선택) 로컬 체크",
              "sleep 1",
              "curl -I http://localhost:80 || true"
            ]' \
            --region "${{ secrets.AWS_REGION }}"
